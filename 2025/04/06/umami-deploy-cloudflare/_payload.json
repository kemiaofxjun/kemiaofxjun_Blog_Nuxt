[{"data":1,"prerenderedAt":415},["ShallowReactive",2],{"/2025/04/06/umami-deploy-cloudflare":3,"surround-/2025/04/06/umami-deploy-cloudflare":404},{"id":4,"title":5,"body":6,"categories":379,"date":381,"description":382,"draft":383,"extension":384,"image":385,"meta":386,"navigation":387,"path":388,"readingTime":389,"recommend":394,"references":395,"seo":396,"stem":397,"tags":398,"type":395,"updated":402,"__hash__":403},"content/posts/2025/04/06/Umami-deploy-cloudflare.md","Umami博客访问统计Vercel+Cloudflare Wokers部署",{"type":7,"value":8,"toc":371},"minimark",[9,14,51,61,68,73,78,85,125,130,137,141,147,170,175,180,183,192,224,229,246,251,258,264,274,280,288,294,300,307,312,315,320,323,327,334,340,343,357,360,363],[10,11,13],"h2",{"id":12},"第一部分vercelumami","第一部分：Vercel+Umami",[15,16,17,48],"ol",{},[18,19,20,21,25,26,33,34,37,42,44,45],"li",{},"第一步\n1.1 ",[22,23,24],"kbd",{},"Fork","​",[27,28,32],"a",{"href":29,"rel":30},"https://github.com/umami-software/umami",[31],"nofollow","umami","到自己的Github仓库",[35,36],"br",{},[38,39],"img",{"alt":40,"src":41},"","https://s2.loli.net/2025/04/06/c4xDVNrsBpTM8YZ.webp",[35,43],{},"1.2 创建项目\n",[38,46],{"alt":40,"src":47},"https://s2.loli.net/2025/04/06/GX9OdivuxF5pJzH.webp",[18,49,50],{},"第二步",[52,53,54,55,60],"p",{},"　2.1 创建",[27,56,59],{"href":57,"rel":58},"https://vercel.com/login",[31],"Vercel","账号，这里我就省略了，因为GitHub可以直接进行授权即可。",[52,62,63,64,67],{},"2.2 在你授权以后，首先创建",[22,65,66],{},"Postgres","数据库，直接一路下一步，创建好就行，可以给下面的连接复制出来",[52,69,70],{},[38,71],{"alt":40,"src":72},"https://s2.loli.net/2025/04/06/K69FpfmjZxcu3Ad.webp",[52,74,75],{},[38,76],{"alt":40,"src":77},"https://s2.loli.net/2025/04/06/7OieEKGht4kgSux.webp",[52,79,80,81,84],{},"　　点击",[22,82,83],{},"Copy Snippet","，就可以，记住在粘贴的时候是我画线里面的部分，双引号都不需要 ，因为要设置环境变量。",[52,86,87,88,91,92,95,96,99,100,102,103,105,106,110,111,110,114,117,118,120,121,124],{},"　　 2.3 在创建好数据库以后，回到主页面的",[22,89,90],{},"Overview","​，然后右上角有一个",[22,93,94],{},"Add New","​选择添加",[22,97,98],{},"Project","​，选择你",[22,101,24],{},"​的",[22,104,32],{},"​，添加即可。\n2.4 设置环境变量，",[107,108,109],"code",{},"DATABASE_URL","​和",[107,112,113],{},"HASH_SALT",[107,115,116],{},"TRACKER_SCRIPT_NAME","​，其中",[107,119,109],{},"​的值就是上面划线的部分，其他的两个环境变量都是对应的值是String自己可以随意定义。\n　　 2.5 设置好以后点击",[22,122,123],{},"Deploy","​，等待大约两分钟左右，自动部署完成，部署完成以后可以通过下图种面板上面给的链接可以直接访问。",[52,126,127],{},[38,128],{"alt":40,"src":129},"https://s2.loli.net/2025/04/06/ahX2wHLrfYAD7ZW.webp",[52,131,132,133,136],{},"　　 2.6 打开以后会跳出登录地址，默认的登录密码是",[22,134,135],{},"adminumami","​，登录进去以后，设置给自己密码修改了，然后就是设置里面添加网站，给你要统计的网站添加进去，到此，别人访问你的网站你可以通过面板看到统计数据了。",[10,138,140],{"id":139},"第二部分umamicloudflare-worker这一部分主要是让你的博客上面能展示的访问数据效果如下","第二部分：Umami+Cloudflare worker这一部分主要是让你的博客上面能展示的访问数据，效果如下：",[52,142,143],{},[38,144],{"alt":145,"src":146},"image","https://s2.loli.net/2025/04/06/fR71aFG4oMD29Pz.webp",[15,148,149],{},[18,150,151,152,155,156,110,159,162,163,166,167],{},"注册",[22,153,154],{},"CloudFlare","​账号，然后进去以后，选择",[22,157,158],{},"Workers",[22,160,161],{},"Pages","​，点击",[22,164,165],{},"创建","​，再点击",[22,168,169],{},"部署",[52,171,172],{},[38,173],{"alt":40,"src":174},"https://s2.loli.net/2025/04/06/CYojqdGHkiuFepQ.webp",[52,176,177],{},[38,178],{"alt":40,"src":179},"https://s2.loli.net/2025/04/06/6B2rXxk4Uu71GQC.webp",[52,181,182],{},"　　部署以后，进去点击编辑代码，将里面的代码进行替换：",[184,185,190],"pre",{"className":186,"code":188,"language":189},[187],"language-text","addEventListener('fetch', event => {\n  event.respondWith(handleRequest(event));\n});\n\nconst API_BASE_URL = 'https://umami.yourdomain.com';  // 替换你的刚才部署的umami的域名\nconst TOKEN = 'your_token'; // 获取的token\nconst WEBSITE_ID = 'your_website_id'; // 在umami添加网站的 webstie id\nconst CACHE_KEY = 'umami_cache';\nconst CACHE_TIME = 600; // Cache time in seconds\n\nasync function fetchUmamiData(startAt, endAt) {\n  const url = `${API_BASE_URL}/api/websites/${WEBSITE_ID}/stats?startAt=${startAt}&endAt=${endAt}`;\n  const response = await fetch(url, {\n    headers: {\n      'Authorization': `Bearer ${TOKEN}`,\n      'Content-Type': 'application/json'\n    }\n  });\n\n  if (!response.ok) {\n    console.error(`Error fetching data: ${response.statusText}`);\n    return null;\n  }\n\n  return response.json();\n}\n\nasync function handleRequest(event) {\n  const cache = await caches.open(CACHE_KEY);\n  const cachedResponse = await cache.match(event.request);\n\n  if (cachedResponse) {\n    return cachedResponse;\n  }\n\n  const now = Date.now();\n  const todayStart = new Date(now).setHours(0, 0, 0, 0);\n  const yesterdayStart = new Date(now - 86400000).setHours(0, 0, 0, 0);\n  const lastMonthStart = new Date(now).setMonth(new Date(now).getMonth() - 1);\n  const lastYearStart = new Date(now).setFullYear(new Date(now).getFullYear() - 1);\n\n  const [todayData, yesterdayData, lastMonthData, lastYearData] = await Promise.all([\n    fetchUmamiData(todayStart, now),\n    fetchUmamiData(yesterdayStart, todayStart),\n    fetchUmamiData(lastMonthStart, now),\n    fetchUmamiData(lastYearStart, now)\n  ]);\n\n  const responseData = {\n    today_uv: todayData?.visitors?.value ?? null,\n    today_pv: todayData?.pageviews?.value ?? null,\n    yesterday_uv: yesterdayData?.visitors?.value ?? null,\n    yesterday_pv: yesterdayData?.pageviews?.value ?? null,\n    last_month_pv: lastMonthData?.pageviews?.value ?? null,\n    last_year_pv: lastYearData?.pageviews?.value ?? null\n  };\n\n  const jsonResponse = new Response(JSON.stringify(responseData), {\n    headers: {\n      'Content-Type': 'application/json',\n      'Access-Control-Allow-Origin': '*',\n      'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE, OPTIONS',\n      'Access-Control-Allow-Headers': 'Content-Type, Authorization'\n    }\n  });\n\n  event.waitUntil(cache.put(event.request, jsonResponse.clone()));\n\n  return jsonResponse;\n}\n","text",[107,191,188],{"__ignoreMap":40},[52,193,194,195,198,199,198,202,205,206,110,208,210,211,213,214,216,217,220,221,223],{},"　　但是里面有几个比较重要的参数需要修改",[107,196,197],{},"API_BASE_URL","​、",[107,200,201],{},"TOKEN",[107,203,204],{},"WEBSITE_ID","​其中",[107,207,197],{},[107,209,204],{},"​已经是有的，",[107,212,204],{},"​在",[22,215,32],{},"​中的设置，选择你已经添加好的网站，点击",[22,218,219],{},"编辑","​，会出现网站的",[107,222,204],{},"​：",[52,225,226],{},[38,227],{"alt":40,"src":228},"https://s2.loli.net/2025/04/06/eFHEYB45nQOUAML.webp",[52,230,231,232,235,236,239,240,245],{},"　　 2.2 获取",[22,233,234],{},"token","​，在想",[22,237,238],{},"api","​测试网站，",[27,241,244],{"href":242,"rel":243},"https://hoppscotch.io/",[31],"hoppscotch","，跳转到这个页面以后，如下图所示",[52,247,248],{},[38,249],{"alt":40,"src":250},"https://s2.loli.net/2025/04/06/vXrQmtpu4HdIasN.webp",[52,252,253,254,257],{},"　　  2.2.1 请求方式选择",[22,255,256],{},"post","​，链接填写方式是：",[184,259,262],{"className":260,"code":261,"language":189},[187],"https://你的umami域名或者是链接/api/auth/login\n",[107,263,261],{"__ignoreMap":40},[52,265,266,267,270,271],{},"　　  2.2.2 请求体选择",[22,268,269],{},"Body","​参数格式选择",[22,272,273],{},"application/json",[184,275,278],{"className":276,"code":277,"language":189},[187],"{\n \"username\":\"用户名\",\n \"password\":\"密码\"\n}\n",[107,279,277],{"__ignoreMap":40},[52,281,282,283,285,286],{},"　　  2.2.3 返回结果中",[22,284,234],{},"​里面的内容就是需要的",[22,287,234],{},[184,289,292],{"className":290,"code":291,"language":189},[187],"{\n  \"token\": \"你的token\", # 你需要记录下来的内容\n  \"user\": {\n    \"id\": \"41e2b680-648e-4b09-bcd7-3e2b10c06264\",\n    \"username\": \"admin\",\n    \"role\": \"admin\",\n    \"createdAt\": \"2024-11-12T09:18:12.766Z\",\n    \"isAdmin\": true\n  }\n}\n",[107,293,291],{"__ignoreMap":40},[52,295,296,297,299],{},"　　到这里，你部署",[107,298,238],{},"​所需要的所有参数内容都已经有了，给替换进去即可。",[52,301,302,303,306],{},"　　 2.3 测试在你部署好以后，会有一个链接，当然你如果是用",[22,304,305],{},"cloudflare","​代理你的域名，可以直接进行关联。",[52,308,309],{},[38,310],{"alt":40,"src":311},"https://s2.loli.net/2025/04/07/IPCS2rhLbiaX3G8.webp",[52,313,314],{},"　　然后点击或则是复制粘贴到浏览器，请求以后会出来下面的结果：",[52,316,317],{},[38,318],{"alt":40,"src":319},"https://s2.loli.net/2025/04/07/M9wsiYKBoGyLI8T.webp",[52,321,322],{},"　　如果没有结果，建议你先去你部署的umami面板里面看看有没有数据，有数据的情况下，这里请求都会有数据的，清理浏览器缓存开代理在测试。",[10,324,326],{"id":325},"第三部分添加博客统计","第三部分：添加博客统计",[52,328,329,330,333],{},"　　将数据添加到",[22,331,332],{},"about","​页面",[184,335,338],{"className":336,"code":337,"language":189},[187],"tj: # 统计\n  provider: custom # custom\n  url: 你的数据接口地址\n  img: https://7.isyangs.cn/1/65eb2e9109826-1.png # 背景\n  desc: # 卡片左下角描述\n",[107,339,337],{"__ignoreMap":40},[52,341,342],{},"　　配置完成~",[52,344,345,346,351,352],{},"　　感谢",[27,347,350],{"href":348,"rel":349},"https://blog.starsharbor.com/",[31],"starsharbor","大佬博客的指导，",[27,353,356],{"href":354,"rel":355},"https://blog.starsharbor.com/posts/solitude-about_umami/",[31],"原文",[358,359],"hr",{},[10,361,362],{"id":362},"作者原文",[52,364,365,366,370],{},"作者: Couture\n链接: ",[27,367,368],{"href":368,"rel":369},"https://www.coutures.top/posts/27233.html",[31],"\n来源: Couture\n著作权归作者所有。 商业转载请联系作者获得授权，非商业转载请注明出处。",{"title":40,"searchDepth":372,"depth":372,"links":373},4,[374,376,377,378],{"id":12,"depth":375,"text":13},2,{"id":139,"depth":375,"text":140},{"id":325,"depth":375,"text":326},{"id":362,"depth":375,"text":362},[380],"技术分享","2025-04-06 23:25:55","Umami博客访问统计Vercel+Cloudflare Wokers部署教程。",false,"md","https://i1.wp.com/dev.ruom.top/i/2025/04/07/951842.webp",{},true,"/2025/04/06/umami-deploy-cloudflare",{"text":390,"minutes":391,"time":392,"words":393},"6 min read",5.55,333000,1110,5,null,{"title":5,"description":382},"posts/2025/04/06/Umami-deploy-cloudflare",[399,400,32,401],"教程","cloudfalre workers","vercel","2025-04-07 00:10:59","CLdklV1IcvotE47FpjXHCJtU1U41BENR2flJkzITGJI",[405,410],{"title":406,"path":407,"stem":408,"date":409,"type":395,"children":-1},"Git 同步上游仓库的更新","/2025/04/04/git-tongbu","posts/2025/04/04/Git-tongbu","2025-04-04 20:13:15",{"title":411,"path":412,"stem":413,"date":414,"type":395,"children":-1},"Waline评论在Vercel部署","/2025/04/14/waline-deploy-vercel","posts/2025/04/14/Waline-deploy-Vercel","2025-04-14 08:08:30",1756211677329]